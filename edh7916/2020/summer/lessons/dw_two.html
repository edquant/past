<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="viewport" content="width=device-width">
<link rel="stylesheet" href="/past/edh7916/2020/summer/assets/css/style.css">
<link rel="stylesheet" href="/past/edh7916/2020/summer/assets/css/syntax_default.css">
<link rel="shortcut icon" type="image/png" href="/past/edh7916/2020/summer/assets/img/favicon.ico">
<link crossorigin="anonymous" media="all" integrity="sha512-uhAd27cNiLn0VE2GVEVUN8D5zW0o7s0QTnCGMnJZkL2HqN9/LwHDi4ndTPJH0upUQHYl/8QF6cwbOYp/KIzlJQ==" rel="stylesheet" href="https://github.githubassets.com/assets/github-be4e45349cf088df7a6636f437c0a167.css" />
<script defer src="/past/edh7916/2020/summer/assets/js/all.min.js"></script>
<!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script async defer src="https://buttons.github.io/buttons.js"></script>
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

<title>edquant | EDH 7916: Contemporary Research in Higher Education</title>

  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>EDH 7916: Contemporary Research in Higher Education<a href="https://github.com/edquant/past/edh7916/2020/summer" class="iconlink">
	      <i class="fab fa-github fa-sm"></i></a></h1>
	<h2 class="thin">Summer 2020 (Session C)</h2>
	<p>A course in quantitative research workflow for students in
the higher education administration program at the University of Florida
</p>
	<!-- side / top bar menu -->
	<h2 class="thin">
	  <a href="/past/edh7916/2020/summer/">Overview</a></br>
	  <a href="/past/edh7916/2020/summer/syllabus/">Course
	    information</a></br>
	  <!-- <a href="/past/edh7916/2020/summer/location/">Meeting -->
	  <!--   location</a></br> -->
	  <a href="/past/edh7916/2020/summer/software/">Software</a></br>
	  <a href="/past/edh7916/2020/summer/schedule/">Schedule</a></br>
	  <a href="/past/edh7916/2020/summer/lessons/">Lessons</a></br>
	  <a href="/past/edh7916/2020/summer/assignments/">Assignments</a></br>
	  <a href="/past/edh7916/2020/summer/questions/">Questions</a></br>
	  <a href="/past/edh7916/2020/summer/past/">Past courses</a></br>
	  <a href="/past/edh7916/2020/summer/about/">About</a></br>	  
	</h2>
      </header>

      <section>
	<h1>Data Wrangling II: Appending, joining, and reshaping data</h1>
	

	
<p>
  
  <a href="/past/edh7916/2020/summer/assets/pdf/dw_two.pdf"
     class="iconlink" download title="Get PDF of lesson">
  <i class="far fa-file-pdf fa-2x"></i>
  </a>
  
  &nbsp;&nbsp;
  
  <a href="/past/edh7916/2020/summer/scripts/dw_two.R"
     class="iconlink" download title="Get script">
    <i class="fas fa-code fa-2x"></i>
  </a>
  &nbsp;&nbsp;
  
  
  
  
  
  <a href="/past/edh7916/2020/summer/data/sch_test.zip"
     class="iconlink" download title="Get data">
    <i class="fas fa-database fa-2x"></i>
  </a>
  &nbsp;&nbsp;
  
  
</p>


<p>So far, we have only worked with single data files: we read in a file,
wrangled our data, and, sometimes, outputted a new file. But very
often, a key aspect of the data wrangling workflow is to combine more
than one data set together. This may include <strong>appending</strong> new rows to an
existing data frame in memory or <strong>joining</strong> two data sets together using
a common key value found in both. Another key data manipulation task
is to <strong>reshape</strong> our data, pivoting from wide to long form (or vice
versa). We’ll go through each individually below.</p>

<h1 id="data">Data</h1>

<p>After you download and unzip the data for today’s lesson, move the
full folder, <code class="language-plaintext highlighter-rouge">sch_test</code>, into the <code class="language-plaintext highlighter-rouge">data</code> subdirectory. It should look
something like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|__ data/
    |-- ...
    |__ sch_test/
        |-- all_schools.csv
        |-- all_schools_wide.csv
        |__ by_school/
            |-- bend_gate_1980.csv
            |-- bend_gate_1981.csv
            |...
            |-- spottsville_1985.csv
</code></pre></div></div>

<p>These fake data represent test scores across three subjects — math,
reading, and science — across four schools over six years. Each
school has a file for each year in the <code class="language-plaintext highlighter-rouge">by_school</code> subdirectory. The
two files in <code class="language-plaintext highlighter-rouge">sch_test</code> directory, <code class="language-plaintext highlighter-rouge">all_schools.csv</code> and
<code class="language-plaintext highlighter-rouge">all_schools_wide.csv</code>, combine the individual files but in different
formats. We’ll use these data sets to practice appending, joining, and
reshaping.</p>

<h1 id="setup">Setup</h1>

<p>As always, we begin by reading in the tidyverse library and
assigning our paths to macros we can reuse below.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## ---------------------------</span><span class="w">
</span><span class="c1">## libraries</span><span class="w">
</span><span class="c1">## ---------------------------</span><span class="w">

</span><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>── Attaching packages ─────────────────────────────────────── tidyverse 1.3.0 ──
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>✔ ggplot2 3.3.0     ✔ purrr   0.3.4
✔ tibble  3.0.1     ✔ dplyr   0.8.5
✔ tidyr   1.1.0     ✔ stringr 1.4.0
✔ readr   1.3.1     ✔ forcats 0.5.0
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
</code></pre></div></div>

<p>As we did in the past lesson, we run this script assuming that
our working directory is set to the <code class="language-plaintext highlighter-rouge">scripts</code> directory. Notice that
we also include macros for our subdirectories within the <code class="language-plaintext highlighter-rouge">data</code>
directory. Since they are nested, we can use the previous macros to
set new macros.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## ---------------------------</span><span class="w">
</span><span class="c1">## directory paths</span><span class="w">
</span><span class="c1">## ---------------------------</span><span class="w">

</span><span class="c1">## assume we're running this script from the ./scripts subdirectory</span><span class="w">
</span><span class="n">dat_dir</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">file.path</span><span class="p">(</span><span class="s2">".."</span><span class="p">,</span><span class="w"> </span><span class="s2">"data"</span><span class="p">)</span><span class="w">
</span><span class="n">sch_dir</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">file.path</span><span class="p">(</span><span class="n">dat_dir</span><span class="p">,</span><span class="w"> </span><span class="s2">"sch_test"</span><span class="p">)</span><span class="w">  </span><span class="c1"># use dat_dir</span><span class="w">
</span><span class="n">bys_dir</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">file.path</span><span class="p">(</span><span class="n">sch_dir</span><span class="p">,</span><span class="w"> </span><span class="s2">"by_school"</span><span class="p">)</span><span class="w"> </span><span class="c1"># use sch_dir</span><span class="w">
</span></code></pre></div></div>

<h1 id="appending-data">Appending data</h1>

<p>Our first task is the most straightforward. When appending data, we
simply add similarly structured rows to an exiting data frame. What do
I mean by similarly structured? Imagine you have a data frame that
looks like this:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">id</th>
      <th style="text-align: center">year</th>
      <th style="text-align: center">score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">A</td>
      <td style="text-align: center">2020</td>
      <td style="text-align: center">98</td>
    </tr>
    <tr>
      <td style="text-align: center">B</td>
      <td style="text-align: center">2020</td>
      <td style="text-align: center">95</td>
    </tr>
    <tr>
      <td style="text-align: center">C</td>
      <td style="text-align: center">2020</td>
      <td style="text-align: center">85</td>
    </tr>
    <tr>
      <td style="text-align: center">D</td>
      <td style="text-align: center">2020</td>
      <td style="text-align: center">94</td>
    </tr>
  </tbody>
</table>

<p>Now, assume you are given data that look like this:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">id</th>
      <th style="text-align: center">year</th>
      <th style="text-align: center">score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">E</td>
      <td style="text-align: center">2020</td>
      <td style="text-align: center">99</td>
    </tr>
    <tr>
      <td style="text-align: center">F</td>
      <td style="text-align: center">2020</td>
      <td style="text-align: center">90</td>
    </tr>
  </tbody>
</table>

<p>These data are similarly structured: <em>same column names in the same
order</em>. If we know that the data came from the same process (<em>e.g.</em>,
<strong>id</strong>s represent students in the same classroom with each file
representing a different test day), then we can safely append the
second to the first:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">id</th>
      <th style="text-align: center">year</th>
      <th style="text-align: center">score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">A</td>
      <td style="text-align: center">2020</td>
      <td style="text-align: center">98</td>
    </tr>
    <tr>
      <td style="text-align: center">B</td>
      <td style="text-align: center">2020</td>
      <td style="text-align: center">95</td>
    </tr>
    <tr>
      <td style="text-align: center">C</td>
      <td style="text-align: center">2020</td>
      <td style="text-align: center">85</td>
    </tr>
    <tr>
      <td style="text-align: center">D</td>
      <td style="text-align: center">2020</td>
      <td style="text-align: center">94</td>
    </tr>
    <tr>
      <td style="text-align: center"><em>E</em></td>
      <td style="text-align: center"><em>2020</em></td>
      <td style="text-align: center"><em>99</em></td>
    </tr>
    <tr>
      <td style="text-align: center"><em>F</em></td>
      <td style="text-align: center"><em>2020</em></td>
      <td style="text-align: center"><em>90</em></td>
    </tr>
  </tbody>
</table>

<p>Data that are the result of the <em>exact</em> same data collecting process
across locations or time may be appended. In education research,
administrative data are often recorded each term or year, meaning you
can build a panel data set by appending. The NCES IPEDS data files
generally work like this.</p>

<p>However, it’s incumbent upon you as the researcher to understand your
data. Just because you are able to append (R will try to make it work
for you) doesn’t mean you always should. What if the <code class="language-plaintext highlighter-rouge">score</code> column in
our data weren’t on the same scale? What if the test date mattered but
isn’t included in the file? What if the files actually represent
scores from different grades or schools? It’s possible that we can
account for each of these issues as we clean our data, but it won’t
happen automatically — append with care!</p>

<!-- > #### Quick exercise  -->
<!-- > While appending data can be straightforward, it can also be -->
<!-- > _dangerous_. What do you think I mean by that? Think of some -->
<!-- > situations in which appending data frames may not be a good idea. -->

<h2 id="example">Example</h2>

<p>Let’s practice with an example. First, we’ll read in three data files
from the <code class="language-plaintext highlighter-rouge">by_school</code> directory.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## ---------------------------</span><span class="w">
</span><span class="c1">## input</span><span class="w">
</span><span class="c1">## ---------------------------</span><span class="w">

</span><span class="c1">## read in data, storing in df_*, where * is a unique number</span><span class="w">
</span><span class="n">df_1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="n">file.path</span><span class="p">(</span><span class="n">bys_dir</span><span class="p">,</span><span class="w"> </span><span class="s2">"bend_gate_1980.csv"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Parsed with column specification:
cols(
  school = col_character(),
  year = col_double(),
  math = col_double(),
  read = col_double(),
  science = col_double()
)
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="n">file.path</span><span class="p">(</span><span class="n">bys_dir</span><span class="p">,</span><span class="w"> </span><span class="s2">"bend_gate_1981.csv"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Parsed with column specification:
cols(
  school = col_character(),
  year = col_double(),
  math = col_double(),
  read = col_double(),
  science = col_double()
)
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="n">file.path</span><span class="p">(</span><span class="n">bys_dir</span><span class="p">,</span><span class="w"> </span><span class="s2">"bend_gate_1982.csv"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Parsed with column specification:
cols(
  school = col_character(),
  year = col_double(),
  math = col_double(),
  read = col_double(),
  science = col_double()
)
</code></pre></div></div>

<p>Looking at each, we can see that they are similarly structured, with
the following columns in the same order: <code class="language-plaintext highlighter-rouge">school</code>, <code class="language-plaintext highlighter-rouge">year</code>, <code class="language-plaintext highlighter-rouge">math</code>,
<code class="language-plaintext highlighter-rouge">read</code>, <code class="language-plaintext highlighter-rouge">science</code>:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## ---------------------------</span><span class="w">
</span><span class="c1">## process</span><span class="w">
</span><span class="c1">## ---------------------------</span><span class="w">

</span><span class="c1">## show each</span><span class="w">
</span><span class="n">df_1</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># A tibble: 1 x 5
  school     year  math  read science
  &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
1 Bend Gate  1980   515   281     808
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_2</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># A tibble: 1 x 5
  school     year  math  read science
  &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
1 Bend Gate  1981   503   312     814
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_3</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># A tibble: 1 x 5
  school     year  math  read science
  &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
1 Bend Gate  1982   514   316     816
</code></pre></div></div>

<p>From the dplyr library, we use the
<a href="https://dplyr.tidyverse.org/reference/bind.html"><code class="language-plaintext highlighter-rouge">bind_rows()</code></a>
function to append the second and third data frames to the first.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## append files</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">bind_rows</span><span class="p">(</span><span class="n">df_1</span><span class="p">,</span><span class="w"> </span><span class="n">df_2</span><span class="p">,</span><span class="w"> </span><span class="n">df_3</span><span class="p">)</span><span class="w">

</span><span class="c1">## show</span><span class="w">
</span><span class="n">df</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># A tibble: 3 x 5
  school     year  math  read science
  &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
1 Bend Gate  1980   515   281     808
2 Bend Gate  1981   503   312     814
3 Bend Gate  1982   514   316     816
</code></pre></div></div>
<p>That’s it!</p>

<blockquote>
  <h4 id="quick-exercise">Quick exercise</h4>
  <p>Read in the rest of the files for Bend Gate and append them to the
current data frame.</p>
</blockquote>

<h1 id="joining-data">Joining data</h1>

<p>More often than appending your data files, however, you will need to
merge or join them. With a join, you add to your data frame new
columns (new variables) that come from a second data frame. The key
difference between joining and appending is that a join requires a
<em>key</em>, that is, a variable or index common to each data frame that
uniquely identifies observations. It’s this key that’s used to line
everything up.</p>

<p>For example, say you have these two data sets,</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">id</th>
      <th style="text-align: center">sch</th>
      <th>year</th>
      <th style="text-align: center">score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">A</td>
      <td style="text-align: center">1</td>
      <td>2020</td>
      <td style="text-align: center">98</td>
    </tr>
    <tr>
      <td style="text-align: center">B</td>
      <td style="text-align: center">1</td>
      <td>2020</td>
      <td style="text-align: center">95</td>
    </tr>
    <tr>
      <td style="text-align: center">C</td>
      <td style="text-align: center">2</td>
      <td>2020</td>
      <td style="text-align: center">85</td>
    </tr>
    <tr>
      <td style="text-align: center">D</td>
      <td style="text-align: center">3</td>
      <td>2020</td>
      <td style="text-align: center">94</td>
    </tr>
  </tbody>
</table>

<table>
  <thead>
    <tr>
      <th style="text-align: center">sch</th>
      <th style="text-align: center">type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">1</td>
      <td style="text-align: center">elementary</td>
    </tr>
    <tr>
      <td style="text-align: center">2</td>
      <td style="text-align: center">middle</td>
    </tr>
    <tr>
      <td style="text-align: center">3</td>
      <td style="text-align: center">high</td>
    </tr>
  </tbody>
</table>

<p>and you want to add the school <code class="language-plaintext highlighter-rouge">type</code> to the first data set. You can
do this because you have a common <em>key</em> between each set: <code class="language-plaintext highlighter-rouge">sch</code>. A
pseudocode description of this join would be:</p>

<ol>
  <li>Add a column to the first data frame called <code class="language-plaintext highlighter-rouge">type</code></li>
  <li>Fill in each row of the new column with the <code class="language-plaintext highlighter-rouge">type</code> value that
corresponds to the matching <code class="language-plaintext highlighter-rouge">sch</code> value in both data frames:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">sch == 1 --&gt; elementary</code></li>
      <li><code class="language-plaintext highlighter-rouge">sch == 2 --&gt; middle</code></li>
      <li><code class="language-plaintext highlighter-rouge">sch == 3 --&gt; high</code></li>
    </ul>
  </li>
</ol>

<p>The end result would then look like this:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">id</th>
      <th style="text-align: center">sch</th>
      <th>year</th>
      <th style="text-align: center">score</th>
      <th style="text-align: left">type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">A</td>
      <td style="text-align: center">1</td>
      <td>2020</td>
      <td style="text-align: center">98</td>
      <td style="text-align: left">elementary</td>
    </tr>
    <tr>
      <td style="text-align: center">B</td>
      <td style="text-align: center">1</td>
      <td>2020</td>
      <td style="text-align: center">95</td>
      <td style="text-align: left">elementary</td>
    </tr>
    <tr>
      <td style="text-align: center">C</td>
      <td style="text-align: center">2</td>
      <td>2020</td>
      <td style="text-align: center">85</td>
      <td style="text-align: left">middle</td>
    </tr>
    <tr>
      <td style="text-align: center">D</td>
      <td style="text-align: center">3</td>
      <td>2020</td>
      <td style="text-align: center">94</td>
      <td style="text-align: left">high</td>
    </tr>
  </tbody>
</table>

<h2 id="example-1">Example</h2>

<p>A common join task in education research involves adding group-level
aggregate statistics to individual observations: for example, adding
school-level average test scores to each student’s row. With a panel
data set (observations across time), we might want within-year
averages added to each unit-by-time period row. Let’s do the second,
adding within-year across school average test scores to each
school-by-year observation.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## ---------------------------</span><span class="w">
</span><span class="c1">## input</span><span class="w">
</span><span class="c1">## ---------------------------</span><span class="w">

</span><span class="c1">## read in all_schools data</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="n">file.path</span><span class="p">(</span><span class="n">sch_dir</span><span class="p">,</span><span class="w"> </span><span class="s2">"all_schools.csv"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Parsed with column specification:
cols(
  school = col_character(),
  year = col_double(),
  math = col_double(),
  read = col_double(),
  science = col_double()
)
</code></pre></div></div>

<p>Looking at the data, we see that it’s similar to what we’ve seen
above, with additional schools.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## show</span><span class="w">
</span><span class="n">df</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># A tibble: 24 x 5
   school        year  math  read science
   &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
 1 Bend Gate     1980   515   281     808
 2 Bend Gate     1981   503   312     814
 3 Bend Gate     1982   514   316     816
 4 Bend Gate     1983   491   276     793
 5 Bend Gate     1984   502   310     788
 6 Bend Gate     1985   488   280     789
 7 East Heights  1980   501   318     782
 8 East Heights  1981   487   323     813
 9 East Heights  1982   496   294     818
10 East Heights  1983   497   306     795
# … with 14 more rows
</code></pre></div></div>

<p>Our task is two-fold:</p>

<ol>
  <li>Get the average of each test score (math, reading, science) across
all schools within each year and save the summary data frame in an
object.</li>
  <li>Join the new summary data frame to the original data frame.</li>
</ol>

<h3 id="1-get-summary">1. Get summary</h3>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## ---------------------------</span><span class="w">
</span><span class="c1">## process</span><span class="w">
</span><span class="c1">## ---------------------------</span><span class="w">

</span><span class="c1">## get test score summary </span><span class="w">
</span><span class="n">df_sum</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1">## grouping by year so average within each year</span><span class="w">
    </span><span class="n">group_by</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1">## get mean(&lt;score&gt;) for each test</span><span class="w">
    </span><span class="n">summarize</span><span class="p">(</span><span class="n">math_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">math</span><span class="p">),</span><span class="w">
              </span><span class="n">read_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">read</span><span class="p">),</span><span class="w">
              </span><span class="n">science_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">science</span><span class="p">))</span><span class="w">

</span><span class="c1">## show</span><span class="w">
</span><span class="n">df_sum</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># A tibble: 6 x 4
   year math_m read_m science_m
  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;
1  1980   507    295.      798.
2  1981   496.   293.      788.
3  1982   506    302.      802.
4  1983   500    293.      794.
5  1984   490    300.      792.
6  1985   500.   290.      794.
</code></pre></div></div>

<blockquote>
  <h4 id="quick-exercise-1">Quick exercise</h4>
  <p>Thinking ahead, why do you think we created new names for the
summarized columns? Why the <code class="language-plaintext highlighter-rouge">_m</code> ending?</p>
</blockquote>

<h3 id="2-join">2. Join</h3>

<p>While one can <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/merge.html"><code class="language-plaintext highlighter-rouge">merge</code> using base
R</a>,
dplyr uses the <a href="https://en.wikipedia.org/wiki/Join_(SQL)">SQL language of
joins</a>, which can be
conceptually clearer (particularly for those who already have
experience with relational database structures). Here are the most
common joins you will use:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">left_join(x, y)</code>: keep all x, drop unmatched y</li>
  <li><code class="language-plaintext highlighter-rouge">right_join(x, y)</code>: keep all y, drop unmatched x</li>
  <li><code class="language-plaintext highlighter-rouge">inner_join(x, y)</code>: keep only matching</li>
  <li><code class="language-plaintext highlighter-rouge">full_join(x, y)</code>: keep everything</li>
</ul>

<p><img src="../assets/img/joins.png" alt="In the Venn diagrams above, blue represents the observations that are
kept, white the observations that are dropped." /></p>

<p>For example, the result of a <strong>left join</strong> between data frame <em>X</em> and
data frame <em>Y</em> will include all observations in <em>X</em> and those in <em>Y</em>
that are also in
<em>X</em>.</p>

<p><strong>X</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">id</th>
      <th style="text-align: center">col_A</th>
      <th style="text-align: center">col_B</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">001</td>
      <td style="text-align: center">a</td>
      <td style="text-align: center">1</td>
    </tr>
    <tr>
      <td style="text-align: center">002</td>
      <td style="text-align: center">b</td>
      <td style="text-align: center">2</td>
    </tr>
    <tr>
      <td style="text-align: center">003</td>
      <td style="text-align: center">a</td>
      <td style="text-align: center">3</td>
    </tr>
  </tbody>
</table>

<p><strong>Y</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">id</th>
      <th style="text-align: center">col_C</th>
      <th style="text-align: center">col_D</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">001</td>
      <td style="text-align: center">T</td>
      <td style="text-align: center">9</td>
    </tr>
    <tr>
      <td style="text-align: center">002</td>
      <td style="text-align: center">T</td>
      <td style="text-align: center">9</td>
    </tr>
    <tr>
      <td style="text-align: center">004</td>
      <td style="text-align: center">F</td>
      <td style="text-align: center">9</td>
    </tr>
  </tbody>
</table>

<p><strong>XY</strong> (result of left join)</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">id</th>
      <th style="text-align: left">col_A</th>
      <th style="text-align: center">col_B</th>
      <th style="text-align: center">col_C</th>
      <th style="text-align: center">col_D</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">001</td>
      <td style="text-align: left">a</td>
      <td style="text-align: center">1</td>
      <td style="text-align: center">T</td>
      <td style="text-align: center">9</td>
    </tr>
    <tr>
      <td style="text-align: center">002</td>
      <td style="text-align: left">b</td>
      <td style="text-align: center">2</td>
      <td style="text-align: center">T</td>
      <td style="text-align: center">9</td>
    </tr>
    <tr>
      <td style="text-align: center">003</td>
      <td style="text-align: left">a</td>
      <td style="text-align: center">3</td>
      <td style="text-align: center">NA</td>
      <td style="text-align: center">NA</td>
    </tr>
  </tbody>
</table>

<p>Observations in both <em>X</em> and <em>Y</em> (<code class="language-plaintext highlighter-rouge">001</code> and <code class="language-plaintext highlighter-rouge">002</code>, above), will have
data for the columns that were separately in <em>X</em> and <em>Y</em> before. Those
in <em>X</em> only (<code class="language-plaintext highlighter-rouge">003</code>), will have missing values in the new columns that
came from <em>Y</em> because they didn’t exist there. Observations in <em>Y</em> but
not <em>X</em> (<code class="language-plaintext highlighter-rouge">004</code>) are dropped entirely.</p>

<p>Back to our example…</p>

<p>Since we want to join a smaller aggregated data frame, <code class="language-plaintext highlighter-rouge">df_sum</code>, to
the original data frame, <code class="language-plaintext highlighter-rouge">df</code>, we’ll use a <code class="language-plaintext highlighter-rouge">left_join()</code>. The join
functions will try to guess the joining variable (and tell you what it
picked) if you don’t supply one, but we’ll specify one to be clear.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## start with data frame...</span><span class="w">
</span><span class="n">df_joined</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1">## pipe into left_join to join with df_sum using "year" as key</span><span class="w">
    </span><span class="n">left_join</span><span class="p">(</span><span class="n">df_sum</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"year"</span><span class="p">)</span><span class="w">

</span><span class="c1">## show</span><span class="w">
</span><span class="n">df_joined</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># A tibble: 24 x 8
   school        year  math  read science math_m read_m science_m
   &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;
 1 Bend Gate     1980   515   281     808   507    295.      798.
 2 Bend Gate     1981   503   312     814   496.   293.      788.
 3 Bend Gate     1982   514   316     816   506    302.      802.
 4 Bend Gate     1983   491   276     793   500    293.      794.
 5 Bend Gate     1984   502   310     788   490    300.      792.
 6 Bend Gate     1985   488   280     789   500.   290.      794.
 7 East Heights  1980   501   318     782   507    295.      798.
 8 East Heights  1981   487   323     813   496.   293.      788.
 9 East Heights  1982   496   294     818   506    302.      802.
10 East Heights  1983   497   306     795   500    293.      794.
# … with 14 more rows
</code></pre></div></div>

<blockquote>
  <h4 id="quick-exercise-2">Quick exercise</h4>
  <p>Look at the first 10 rows of <code class="language-plaintext highlighter-rouge">df_joined</code>. What do you notice about
the new summary columns we added?</p>
</blockquote>

<h1 id="reshaping-data">Reshaping data</h1>

<p>Reshaping data is a common data wrangling task. Whether going from
<a href="https://en.wikipedia.org/wiki/Wide_and_narrow_data">wide to long format or long to
wide</a>, it can be
a painful process. But with a little practice, the ability to reshape
data will become a powerful tool in your toolbox.</p>

<h2 id="definitions">Definitions</h2>

<p>While there are various definitions of tabular data structure, the two
you will most often come across are <strong>wide</strong> and <strong>long</strong>. Wide data
are data structures in which all variable/values are columns. At the
extreme end, every <em>id</em> will only have a single row:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">id</th>
      <th style="text-align: center">math_score_2019</th>
      <th style="text-align: center">read_score_2019</th>
      <th style="text-align: center">math_score_2020</th>
      <th style="text-align: center">read_score_2020</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">A</td>
      <td style="text-align: center">93</td>
      <td style="text-align: center">88</td>
      <td style="text-align: center">92</td>
      <td style="text-align: center">98</td>
    </tr>
    <tr>
      <td style="text-align: center">B</td>
      <td style="text-align: center">99</td>
      <td style="text-align: center">92</td>
      <td style="text-align: center">97</td>
      <td style="text-align: center">95</td>
    </tr>
    <tr>
      <td style="text-align: center">C</td>
      <td style="text-align: center">89</td>
      <td style="text-align: center">88</td>
      <td style="text-align: center">84</td>
      <td style="text-align: center">85</td>
    </tr>
  </tbody>
</table>

<p>Notice how each particular score (by year) has its own column?
Compare this to long data in which each <em>observational unit</em> (id test
score within a given year) will have a row:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">id</th>
      <th style="text-align: center">year</th>
      <th style="text-align: center">test</th>
      <th style="text-align: center">score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">A</td>
      <td style="text-align: center">2019</td>
      <td style="text-align: center">math</td>
      <td style="text-align: center">93</td>
    </tr>
    <tr>
      <td style="text-align: center">A</td>
      <td style="text-align: center">2019</td>
      <td style="text-align: center">read</td>
      <td style="text-align: center">88</td>
    </tr>
    <tr>
      <td style="text-align: center">A</td>
      <td style="text-align: center">2020</td>
      <td style="text-align: center">math</td>
      <td style="text-align: center">92</td>
    </tr>
    <tr>
      <td style="text-align: center">A</td>
      <td style="text-align: center">2020</td>
      <td style="text-align: center">read</td>
      <td style="text-align: center">98</td>
    </tr>
    <tr>
      <td style="text-align: center">B</td>
      <td style="text-align: center">2019</td>
      <td style="text-align: center">math</td>
      <td style="text-align: center">99</td>
    </tr>
    <tr>
      <td style="text-align: center">B</td>
      <td style="text-align: center">2019</td>
      <td style="text-align: center">read</td>
      <td style="text-align: center">92</td>
    </tr>
    <tr>
      <td style="text-align: center">B</td>
      <td style="text-align: center">2020</td>
      <td style="text-align: center">math</td>
      <td style="text-align: center">97</td>
    </tr>
    <tr>
      <td style="text-align: center">B</td>
      <td style="text-align: center">2020</td>
      <td style="text-align: center">read</td>
      <td style="text-align: center">95</td>
    </tr>
    <tr>
      <td style="text-align: center">C</td>
      <td style="text-align: center">2019</td>
      <td style="text-align: center">math</td>
      <td style="text-align: center">89</td>
    </tr>
    <tr>
      <td style="text-align: center">C</td>
      <td style="text-align: center">2019</td>
      <td style="text-align: center">read</td>
      <td style="text-align: center">88</td>
    </tr>
    <tr>
      <td style="text-align: center">C</td>
      <td style="text-align: center">2020</td>
      <td style="text-align: center">math</td>
      <td style="text-align: center">84</td>
    </tr>
    <tr>
      <td style="text-align: center">C</td>
      <td style="text-align: center">2020</td>
      <td style="text-align: center">read</td>
      <td style="text-align: center">85</td>
    </tr>
  </tbody>
</table>

<p>The first wide and second long table present the same information in a
different format. So why bother reshaping? The short answer is that
you sometimes need one format and sometimes the other due to the
demands of the analysis you want to run, the figure you want to plot,
or the table you want to make.</p>

<p><strong>NB</strong>: Data in the wild are often some combination of these two
types: <em>wide-ish</em> or <em>long-ish</em>. For an example, see our
<code class="language-plaintext highlighter-rouge">all_schools.csv</code> data below, which is wide in some variables (test),
but long in others (year). The point of defining long vs wide is not
to have a testable definition, but rather to have a framework for
thinking about how your data are structured and if that structure will
work for your data analysis needs.</p>

<h2 id="example-wide--long">Example: wide –&gt; long</h2>

<p>To start, we’ll go back to the <code class="language-plaintext highlighter-rouge">all_schools.csv</code> file.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## ---------------------------</span><span class="w">
</span><span class="c1">## input</span><span class="w">
</span><span class="c1">## ---------------------------</span><span class="w">

</span><span class="c1">## reading again just to be sure we have the original data</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="n">file.path</span><span class="p">(</span><span class="n">sch_dir</span><span class="p">,</span><span class="w"> </span><span class="s2">"all_schools.csv"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Parsed with column specification:
cols(
  school = col_character(),
  year = col_double(),
  math = col_double(),
  read = col_double(),
  science = col_double()
)
</code></pre></div></div>

<p>Notice how the data are wide in <strong>test</strong>: each school has one row per
year, but each test gets its own column. While this setup can be
efficient for storage, it’s not always the best for analysis or even
just browsing. What we want is for the data to be long.</p>

<p>Instead of each test having its own column, we would like to make the
data look like our long data example above, with each row representing
a single <em>school</em>, <em>year</em>, <em>test</em>, <em>score</em>:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">school</th>
      <th style="text-align: center">year</th>
      <th style="text-align: left">test</th>
      <th style="text-align: center">score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">Bend Gate</td>
      <td style="text-align: center">1980</td>
      <td style="text-align: left">math</td>
      <td style="text-align: center">515</td>
    </tr>
    <tr>
      <td style="text-align: left">Bend Gate</td>
      <td style="text-align: center">1980</td>
      <td style="text-align: left">read</td>
      <td style="text-align: center">281</td>
    </tr>
    <tr>
      <td style="text-align: left">Bend Gate</td>
      <td style="text-align: center">1980</td>
      <td style="text-align: left">science</td>
      <td style="text-align: center">808</td>
    </tr>
    <tr>
      <td style="text-align: left">…</td>
      <td style="text-align: center">…</td>
      <td style="text-align: left">…</td>
      <td style="text-align: center">…</td>
    </tr>
  </tbody>
</table>

<p>As with joins, you can <a href="https://stats.idre.ucla.edu/r/faq/how-can-i-reshape-my-data-in-r/">reshape data frames using base R
commands</a>.
But again, we’ll use tidyverse functions in the
<a href="http://tidyr.tidyverse.org">tidyr</a> library. Specifically, we’ll rely
on the tidyr <code class="language-plaintext highlighter-rouge">pivot_longer()</code> and <code class="language-plaintext highlighter-rouge">pivot_wider()</code> commands.</p>

<h3 id="pivot_longer"><code class="language-plaintext highlighter-rouge">pivot_longer()</code></h3>

<p>The <code class="language-plaintext highlighter-rouge">pivot_longer()</code> function can take a number of arguments, but the
core things it needs to know are:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">data</code>: the name of the data frame you’re reshaping (we can use
<code class="language-plaintext highlighter-rouge">%&gt;%</code> to pipe in the data name)</li>
  <li><code class="language-plaintext highlighter-rouge">cols</code>: the names of the columns that you want to pivot into values
of a single new column (thereby making the data frame “longer”)</li>
  <li><code class="language-plaintext highlighter-rouge">names_to</code>: the name of the new column that will contain the names
of the <code class="language-plaintext highlighter-rouge">cols</code> you just listed</li>
  <li><code class="language-plaintext highlighter-rouge">values_to</code>: the name of the column where the values in the <code class="language-plaintext highlighter-rouge">cols</code>
you listed will go</li>
</ul>

<p>In our current situation, our <code class="language-plaintext highlighter-rouge">cols</code> to pivot are <code class="language-plaintext highlighter-rouge">"math"</code>, <code class="language-plaintext highlighter-rouge">"read"</code>, and
<code class="language-plaintext highlighter-rouge">"science"</code>. Since they are test types, we’ll call our <code class="language-plaintext highlighter-rouge">names_to</code> column
<code class="language-plaintext highlighter-rouge">"test"</code> and our <code class="language-plaintext highlighter-rouge">values_to</code> column <code class="language-plaintext highlighter-rouge">"score"</code>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## ---------------------------</span><span class="w">
</span><span class="c1">## process</span><span class="w">
</span><span class="c1">## ---------------------------</span><span class="w">

</span><span class="c1">## wide to long</span><span class="w">
</span><span class="n">df_long</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1">## cols: current test columns</span><span class="w">
    </span><span class="c1">## names_to: where "math", "read", and "science" will go</span><span class="w">
    </span><span class="c1">## values_to: where the values in cols will go</span><span class="w">
    </span><span class="n">pivot_longer</span><span class="p">(</span><span class="n">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"math"</span><span class="p">,</span><span class="s2">"read"</span><span class="p">,</span><span class="s2">"science"</span><span class="p">),</span><span class="w">
                 </span><span class="n">names_to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"test"</span><span class="p">,</span><span class="w">
                 </span><span class="n">values_to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"score"</span><span class="p">)</span><span class="w">

</span><span class="c1">## show</span><span class="w">
</span><span class="n">df_long</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># A tibble: 72 x 4
   school     year test    score
   &lt;chr&gt;     &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt;
 1 Bend Gate  1980 math      515
 2 Bend Gate  1980 read      281
 3 Bend Gate  1980 science   808
 4 Bend Gate  1981 math      503
 5 Bend Gate  1981 read      312
 6 Bend Gate  1981 science   814
 7 Bend Gate  1982 math      514
 8 Bend Gate  1982 read      316
 9 Bend Gate  1982 science   816
10 Bend Gate  1983 math      491
# … with 62 more rows
</code></pre></div></div>

<blockquote>
  <h4 id="quick-ocular-test-exercise">Quick (ocular test) exercise</h4>
  <p>How many rows did our initial data frame <code class="language-plaintext highlighter-rouge">df</code> have? How many unique
tests did we have in each year? When reshaping from wide to long,
how many rows should we expect our new data frame to have? Does our
new data frame have that many rows?</p>
</blockquote>

<h2 id="example-long--wide">Example: long –&gt; wide</h2>

<h3 id="pivot_wider"><code class="language-plaintext highlighter-rouge">pivot_wider()</code></h3>

<p>Now that we have our long data, let’s reshape it back to wide format
using <code class="language-plaintext highlighter-rouge">pivot_wider()</code>. In this case, we’re doing just the opposite
from before — here are the main arguments you need to attend to:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">data</code>: the name of the data frame you’re reshaping (we can use
<code class="language-plaintext highlighter-rouge">%&gt;%</code> to pipe in the data name)</li>
  <li><code class="language-plaintext highlighter-rouge">names_from</code>: the name of the column that contains the values which
will become new column names</li>
  <li><code class="language-plaintext highlighter-rouge">values_from</code>: the name of the column that contains the values
associated with the values in <code class="language-plaintext highlighter-rouge">names_from</code> column; these will go
into the new columns.</li>
</ul>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## ---------------------------</span><span class="w">
</span><span class="c1">## process</span><span class="w">
</span><span class="c1">## ---------------------------</span><span class="w">

</span><span class="c1">## long to wide</span><span class="w">
</span><span class="n">df_wide</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df_long</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1">## names_from: values in this column will become new column names</span><span class="w">
    </span><span class="c1">## values_from: values in this column will become values in new cols</span><span class="w">
    </span><span class="n">pivot_wider</span><span class="p">(</span><span class="n">names_from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"test"</span><span class="p">,</span><span class="w">
                </span><span class="n">values_from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"score"</span><span class="p">)</span><span class="w">

</span><span class="c1">## show</span><span class="w">
</span><span class="n">df_wide</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># A tibble: 24 x 5
   school        year  math  read science
   &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
 1 Bend Gate     1980   515   281     808
 2 Bend Gate     1981   503   312     814
 3 Bend Gate     1982   514   316     816
 4 Bend Gate     1983   491   276     793
 5 Bend Gate     1984   502   310     788
 6 Bend Gate     1985   488   280     789
 7 East Heights  1980   501   318     782
 8 East Heights  1981   487   323     813
 9 East Heights  1982   496   294     818
10 East Heights  1983   497   306     795
# … with 14 more rows
</code></pre></div></div>

<blockquote>
  <h4 id="quick-exercise-3">Quick exercise</h4>
  <p>In this case, our new wide data frame, <code class="language-plaintext highlighter-rouge">df_wide</code>, should be the same
as our initial data frame. Is it? How can you tell?</p>
</blockquote>

<h2 id="example-wide--long-with-corrections">Example: wide –&gt; long with corrections</h2>

<p>Unfortunately, it’s not always so clear cut to reshape data. In this
second example, we’ll again reshape from wide to long, but we’ll have
to munge our data a bit after the reshape to make it analysis ready.</p>

<p>First, we’ll read in a second file <code class="language-plaintext highlighter-rouge">all_schools_wide.csv</code>. This file
contains the same information as before, but in a <em>very</em> wide format:
each school has only one row and each test by year value gets its own
column in the form <code class="language-plaintext highlighter-rouge">&lt;test&gt;_&lt;year&gt;</code>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## ---------------------------</span><span class="w">
</span><span class="c1">## input</span><span class="w">
</span><span class="c1">## ---------------------------</span><span class="w">

</span><span class="c1">## read in very wide test score data</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="n">file.path</span><span class="p">(</span><span class="n">sch_dir</span><span class="p">,</span><span class="w"> </span><span class="s2">"all_schools_wide.csv"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Parsed with column specification:
cols(
  school = col_character(),
  math_1980 = col_double(),
  read_1980 = col_double(),
  science_1980 = col_double(),
  math_1981 = col_double(),
  read_1981 = col_double(),
  science_1981 = col_double(),
  math_1982 = col_double(),
  read_1982 = col_double(),
  science_1982 = col_double(),
  math_1983 = col_double(),
  read_1983 = col_double(),
  science_1983 = col_double(),
  math_1984 = col_double(),
  read_1984 = col_double(),
  science_1984 = col_double(),
  math_1985 = col_double(),
  read_1985 = col_double(),
  science_1985 = col_double()
)
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## show</span><span class="w">
</span><span class="n">df</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># A tibble: 4 x 19
  school math_1980 read_1980 science_1980 math_1981 read_1981 science_1981
  &lt;chr&gt;      &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;
1 Bend …       515       281          808       503       312          814
2 East …       501       318          782       487       323          813
3 Niaga…       514       292          787       499       268          762
4 Spott…       498       288          813       494       270          765
# … with 12 more variables: math_1982 &lt;dbl&gt;, read_1982 &lt;dbl&gt;,
#   science_1982 &lt;dbl&gt;, math_1983 &lt;dbl&gt;, read_1983 &lt;dbl&gt;, science_1983 &lt;dbl&gt;,
#   math_1984 &lt;dbl&gt;, read_1984 &lt;dbl&gt;, science_1984 &lt;dbl&gt;, math_1985 &lt;dbl&gt;,
#   read_1985 &lt;dbl&gt;, science_1985 &lt;dbl&gt;
</code></pre></div></div>

<p>Second, we can <code class="language-plaintext highlighter-rouge">pivot_longer()</code> as we did before using the following
values for our key arguments:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">data</code> : <code class="language-plaintext highlighter-rouge">df</code> (but piped in using <code class="language-plaintext highlighter-rouge">%&gt;%</code>)</li>
  <li><code class="language-plaintext highlighter-rouge">cols</code> : use special <a href="https://www.rdocumentation.org/packages/tidyselect/versions/1.0.0/topics/select_helpers">tidyselect helper
function</a>
<code class="language-plaintext highlighter-rouge">contains()</code> to select all test by year columns</li>
  <li><code class="language-plaintext highlighter-rouge">names_to</code>: <code class="language-plaintext highlighter-rouge">test_year</code></li>
  <li><code class="language-plaintext highlighter-rouge">values_to</code>: <code class="language-plaintext highlighter-rouge">score</code></li>
</ul>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## ---------------------------</span><span class="w">
</span><span class="c1">## process</span><span class="w">
</span><span class="c1">## ---------------------------</span><span class="w">

</span><span class="c1">## wide to long</span><span class="w">
</span><span class="n">df_long</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1">## NB: contains() looks for "19" in name: if there, it adds it to cols</span><span class="w">
    </span><span class="n">pivot_longer</span><span class="p">(</span><span class="n">cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">contains</span><span class="p">(</span><span class="s2">"19"</span><span class="p">),</span><span class="w">
                 </span><span class="n">names_to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"test_year"</span><span class="p">,</span><span class="w">
                 </span><span class="n">values_to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"score"</span><span class="p">)</span><span class="w">

</span><span class="c1">## show</span><span class="w">
</span><span class="n">df_long</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># A tibble: 72 x 3
   school    test_year    score
   &lt;chr&gt;     &lt;chr&gt;        &lt;dbl&gt;
 1 Bend Gate math_1980      515
 2 Bend Gate read_1980      281
 3 Bend Gate science_1980   808
 4 Bend Gate math_1981      503
 5 Bend Gate read_1981      312
 6 Bend Gate science_1981   814
 7 Bend Gate math_1982      514
 8 Bend Gate read_1982      316
 9 Bend Gate science_1982   816
10 Bend Gate math_1983      491
# … with 62 more rows
</code></pre></div></div>

<blockquote>
  <h4 id="quick-exercise-4">Quick exercise</h4>
  <p>Why did we use “19” as our value in the contains() function?
<strong>HINT</strong>: use the <code class="language-plaintext highlighter-rouge">names()</code> function to return a list of the
original data frame (<code class="language-plaintext highlighter-rouge">df</code>) column names.</p>
</blockquote>

<p>This mostly worked to get our data long, but now we have this weird
combined <code class="language-plaintext highlighter-rouge">test_year</code> column. What we really want are two columns, one
for the year and one for the test type. We can fix this using <a href="https://tidyr.tidyverse.org/reference/separate.html">tidyr
<code class="language-plaintext highlighter-rouge">separate()</code></a>
function with the following arguments:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">data</code>: our <code class="language-plaintext highlighter-rouge">df_long</code> object, piped in using <code class="language-plaintext highlighter-rouge">%&gt;%</code></li>
  <li><code class="language-plaintext highlighter-rouge">col</code>: the column we want to split (<code class="language-plaintext highlighter-rouge">test_year</code>)</li>
  <li><code class="language-plaintext highlighter-rouge">into</code>: the names of the new columns to create from <code class="language-plaintext highlighter-rouge">col</code> (<code class="language-plaintext highlighter-rouge">test</code>
and <code class="language-plaintext highlighter-rouge">year</code>)</li>
  <li><code class="language-plaintext highlighter-rouge">sep</code>: the name of the character that splits the values in <code class="language-plaintext highlighter-rouge">col</code>, so
R knows how to fill each of the <code class="language-plaintext highlighter-rouge">into</code> columns (<code class="language-plaintext highlighter-rouge">"_"</code>)</li>
</ul>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## separate test_year into two columns, filling appropriately</span><span class="w">
</span><span class="n">df_long_fix</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df_long</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="c1">## col: the column to split</span><span class="w">
    </span><span class="c1">## into: names of resulting splits</span><span class="w">
    </span><span class="c1">## sep: the split point --&gt; left to "test", right to "year"</span><span class="w">
    </span><span class="n">separate</span><span class="p">(</span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"test_year"</span><span class="p">,</span><span class="w">
             </span><span class="n">into</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"test"</span><span class="p">,</span><span class="w"> </span><span class="s2">"year"</span><span class="p">),</span><span class="w">
             </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"_"</span><span class="p">)</span><span class="w">

</span><span class="c1">## show</span><span class="w">
</span><span class="n">df_long_fix</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># A tibble: 72 x 4
   school    test    year  score
   &lt;chr&gt;     &lt;chr&gt;   &lt;chr&gt; &lt;dbl&gt;
 1 Bend Gate math    1980    515
 2 Bend Gate read    1980    281
 3 Bend Gate science 1980    808
 4 Bend Gate math    1981    503
 5 Bend Gate read    1981    312
 6 Bend Gate science 1981    814
 7 Bend Gate math    1982    514
 8 Bend Gate read    1982    316
 9 Bend Gate science 1982    816
10 Bend Gate math    1983    491
# … with 62 more rows
</code></pre></div></div>

<blockquote>
  <h4 id="quick-exercise-5">Quick exercise</h4>
  <p>Redo the last few steps in a single combined chain using pipes. That
is, start with <code class="language-plaintext highlighter-rouge">df</code> (which contains <code class="language-plaintext highlighter-rouge">all_schools_wide.csv</code>), reshape
long, and fix so that you end up with four columns — all in a
single piped chain.</p>
</blockquote>

<h1 id="final-note">Final note</h1>

<p>Just as all data sets are unique, so too are the particular steps you
may need to take to <strong>append</strong>, <strong>join</strong>, or <strong>reshape</strong> your
data. Even experienced coders rarely get all the steps correct the
first try. Be prepared to spend time getting to know your data and
figuring out, through trial and error, how to wrangle it so that it
meets your analytic needs. Code books, institutional/domain knowledge,
and patience are your friends here!</p>




	<!-- <p> -->
	<!--   Updated:  -->
	<!-- </p> -->
      </section>
      <footer>
        <p>
  Benjamin Skinner</br>  
  Assistant Professor</br>  
  University of Florida</br>
  <a href="https://www.btskinner.io" class="iconlink" alt="Personal website">
    <i class="fas fa-home fa-lg"></i></a> | 
  <a href="https://github.com/btskinner" class="iconlink" alt="Github
								profile">
    <i class="fab fa-github fa-lg"></i></a> |
  <a href="https://twitter.com/btskinner" class="iconlink" alt="Twitter profile">
    <i class="fab fa-twitter fa-lg"></i></a>
</p>
<p>
  <small>
    <a href="https://pages.github.com">GitHub Pages</a> |
    <a href="https://github.com/orderedlist/minimal">Theme</a> |
    <a href="/past/edh7916/2020/summer/releases/">Releases</a>
  </small>
</p>

      </footer>
    </div>

    <!-- load Javascript if page requires it -->
    
    
    

    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-63981025-1', 'auto');
        ga('send', 'pageview');
    </script>
  
  </body>
</html>
