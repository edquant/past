<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="viewport" content="width=device-width">
<link rel="stylesheet" href="/past/edh7916/2020/spring/assets/css/style.css">
<link rel="stylesheet" href="/past/edh7916/2020/spring/assets/css/syntax_default.css">
<link rel="shortcut icon" type="image/png" href="/past/edh7916/2020/spring/assets/img/favicon.ico">
<link crossorigin="anonymous" media="all" integrity="sha512-uhAd27cNiLn0VE2GVEVUN8D5zW0o7s0QTnCGMnJZkL2HqN9/LwHDi4ndTPJH0upUQHYl/8QF6cwbOYp/KIzlJQ==" rel="stylesheet" href="https://github.githubassets.com/assets/github-be4e45349cf088df7a6636f437c0a167.css" />
<script defer src="/past/edh7916/2020/spring/assets/js/all.min.js"></script>
<!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script async defer src="https://buttons.github.io/buttons.js"></script>
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

<title>edquant | EDH 7916: Contemporary Research in Higher Education</title>

  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>EDH 7916: Contemporary Research in Higher Education<a href="https://github.com/edquant/past" class="iconlink">
	      <i class="fab fa-github fa-sm"></i></a></h1>
	<h2 class="thin">Spring 2020</h2>
	<p>A course in quantitative research workflow for students in
the higher education administration program at the University of Florida
</p>
	<!-- side / top bar menu -->
	<h2 class="thin">
	  <a href="/past/edh7916/2020/spring/">Overview</a></br>
	  <a href="/past/edh7916/2020/spring/syllabus/">Course
	    information</a></br>
	  <a href="/past/edh7916/2020/spring/location/">Meeting
	    location</a></br>
	  <a href="/past/edh7916/2020/spring/start/">Getting started</a></br>
	  <a href="/past/edh7916/2020/spring/schedule/">Schedule</a></br>
	  <a href="/past/edh7916/2020/spring/lessons/">Lessons</a></br>
	  <a href="/past/edh7916/2020/spring/assignments/">Assignments</a></br>
	  <a href="/past/edh7916/2020/spring/questions/">Questions</a></br>
	  <a href="/past/edh7916/2020/spring/about/">About</a></br>	  
	</h2>
      </header>

      <section>
	<h1>Functional programming</h1>
	

	
<p>
  
  <a href="/past/edh7916/2020/spring/assets/pdf/programming.pdf"
     class="iconlink" download title="Get PDF of lesson">
  <i class="far fa-file-pdf fa-2x"></i>
  </a>
  
  &nbsp;&nbsp;
  
  <a href="/past/edh7916/2020/spring/scripts/programming.R"
     class="iconlink" download title="Get script">
    <i class="fas fa-code fa-2x"></i>
  </a>
  &nbsp;&nbsp;
  
  
  
  
  <a href="/past/edh7916/2020/spring/data/sch_test.zip"
     class="iconlink" download title="Get data">
    <i class="fas fa-database fa-2x"></i>
  </a>
  
</p>


<p>This lesson covers two core programming processes: control flow and
writing functions.</p>

<p>Like other programming languages, R reads scripts from top to bottom,
implementing each command or function as it comes. But like other
languages, it also has special functions that you can use to change how
R moves through the script — to <em>control the flow</em> of the analysis
process. With these special functions, you can selectively implement and
repeat sections of code.</p>

<p>R also allows you to write your own functions. While most of your data
analyses will use functions from base R or a library you load, you may
find it useful to write your own functions from time to time. You might
use your <em>user-written functions</em> to perform specialized tasks or simply
as wrappers for sections of code that you otherwise might repeat
multiple times.</p>

<p>This lesson is divided into three sections. In the first section, we’ll
go through some common control flow processes. In the second section,
we’ll go over the process for building our own functions. In the last
section, we’ll work through two examples of how functional programming
can streamline a data analysis workflow.</p>

<p>But before moving on, we’ll quickly talk about the guiding principle
behind this lesson.</p>

<h1 id="dry-vs-wet-programming"><strong>DRY</strong> vs <strong>WET</strong> programming</h1>

<p>The watchwords for this lesson are <a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself"><strong>DRY</strong> vs
<strong>WET</strong></a>:</p>

<ul>
  <li><strong>DRY</strong>: <em>Don’t repeat yourself</em></li>
  <li><strong>WET</strong>: <em>Write every time</em></li>
</ul>

<p>Let’s say you have a three-step analysis process for 20 files (read,
lower names, add a column). Under a <em>WET</em> programming paradigm in which
each command gets its own line of code, that’s 60 lines of code. If the
number of your files grows to 50, that’s now 150 lines of code — for
just three tasks! When you write every time, you not only make your
code longer and harder to parse, you also <em>increase</em> the likelihood that
your code will contain bugs while simultaneously <em>decreasing</em> its
scalability.</p>

<p>If you need to repeat an analytic task (which may be a set of commands),
then it’s better to have one statement of that process that you repeat,
perhaps in a loop or in a function. Don’t repeat yourself — say it once
and have R repeat it for you!</p>

<p>The goal of DRY programming is not abstraction or slickness for its own
sake. That runs counter to the clarity and replicability we’ve been
working toward. Instead, we aspire to DRY code since it is more scalable
and less buggy than WET code. To be clear, a function or loop can still
have bugs, but the bugs it introduces are often <em>the same across
repetitions</em> and fixed <em>at a single point of error</em>. That is, it’s
typically easier to <em>debug</em> when the bug has a single root cause than
when it could be anywhere in 150 similar but <em>slightly</em> different lines
of code.</p>

<p>As we work through the lesson examples, keep in the back of your mind:</p>

<ol>
  <li><em>What would this code look like if I wrote everything twice (WET)</em>?</li>
  <li><em>How does this DRY process not only reduce the number of lines of
code, but also make my intent clearer?</em></li>
</ol>

<h1 id="setup">Setup</h1>

<p>We’ll use a combination of nonce data and the school test score data
we’ve used in a past lesson. We won’t read in the school test score
data until the last section, but we’ll continue following our good
organizational practice by setting the directory paths at the top of our
script.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## ---------------------------</span><span class="w">
</span><span class="c1">## libraries</span><span class="w">
</span><span class="c1">## ---------------------------</span><span class="w">

</span><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>── Attaching packages ─────────────────────────────────────── tidyverse 1.3.0 ──

✔ ggplot2 3.3.0     ✔ purrr   0.3.4
✔ tibble  3.0.1     ✔ dplyr   0.8.5
✔ tidyr   1.0.2     ✔ stringr 1.4.0
✔ readr   1.3.1     ✔ forcats 0.5.0

── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
</code></pre></div></div>

<p><strong>NB</strong>: As we have done in the past few lessons, we’ll run this script
assuming that our working directory is set to the <code class="language-plaintext highlighter-rouge">scripts</code> directory.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## ---------------------------</span><span class="w">
</span><span class="c1">## directory paths</span><span class="w">
</span><span class="c1">## ---------------------------</span><span class="w">

</span><span class="c1">## assume we're running this script from the ./scripts subdirectory</span><span class="w">
</span><span class="n">dat_dir</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">file.path</span><span class="p">(</span><span class="s2">".."</span><span class="p">,</span><span class="w"> </span><span class="s2">"data"</span><span class="p">)</span><span class="w">
</span><span class="n">sch_dir</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">file.path</span><span class="p">(</span><span class="n">dat_dir</span><span class="p">,</span><span class="w"> </span><span class="s2">"sch_test"</span><span class="p">)</span><span class="w">
</span><span class="n">bys_dir</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">file.path</span><span class="p">(</span><span class="n">sch_dir</span><span class="p">,</span><span class="w"> </span><span class="s2">"by_school"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h1 id="part-1-control-flow">Part 1: Control flow</h1>

<p>As stated above, by <em>control flow</em>, I simply mean the functions that
help you change how your script is read. Repeating commands often
involves a <em>loop</em>, which is what it sounds like: upon reaching a loop, R
will repeat the code inside the loop (<em>looping back up the beginning of
the section</em>) for a certain number of times or until some condition is
met. Once completed, R will go back to reading each line in order like
normal.</p>

<p>If you google around, you may find that loops have a bad reputation in
R, mostly for being slow. But they aren’t <em>that</em> slow and they are easy
to write and understand.</p>

<h2 id="for">for</h2>

<p>The <code class="language-plaintext highlighter-rouge">for()</code> function allows you to build the aptly named <strong>for loops</strong>.
There are few ways to use <code class="language-plaintext highlighter-rouge">for()</code>, but its construction is the same:
<code class="language-plaintext highlighter-rouge">for (variable in sequence)</code>.</p>

<p>Reading it backwards, the <code class="language-plaintext highlighter-rouge">sequence</code> is just the set of numbers or
objects that we’re going to work through. The <code class="language-plaintext highlighter-rouge">variable</code> is a new
variable that will temporarily hold a value from the sequence in each
run through the loop. When the <code class="language-plaintext highlighter-rouge">sequence</code> is finished, so is the loop.</p>

<p>First, let’s loop through a sequence of 10 numbers, printing each one at
a time as we work through the loop.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## make vector of numbers between 1 and 10</span><span class="w">
</span><span class="n">num_sequence</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">10</span><span class="w">

</span><span class="c1">## loop through, printing each num_sequence value, one at a time</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">num_sequence</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] 1
[1] 2
[1] 3
[1] 4
[1] 5
[1] 6
[1] 7
[1] 8
[1] 9
[1] 10
</code></pre></div></div>

<p>Notice the braces <code class="language-plaintext highlighter-rouge">{}</code> that come after <code class="language-plaintext highlighter-rouge">for()</code>. This is the code in the
loop that will be repeated as long as the loop is run. With each loop,
<code class="language-plaintext highlighter-rouge">i</code> takes on the next value in the <code class="language-plaintext highlighter-rouge">num_sequence</code>. This is why we see 1
through 10 printed to the console.</p>

<p>Let’s do it again, but this time with characters.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## character vector using letters object from R base</span><span class="w">
</span><span class="n">chr_sequence</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nb">letters</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">10</span><span class="p">]</span><span class="w">

</span><span class="c1">## loop through, printing each chr_sequence value, one at a time</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">chr_sequence</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] "a"
[1] "b"
[1] "c"
[1] "d"
[1] "e"
[1] "f"
[1] "g"
[1] "h"
[1] "i"
[1] "j"
</code></pre></div></div>

<p>Once more, with each loop, <code class="language-plaintext highlighter-rouge">i</code> takes on each <code class="language-plaintext highlighter-rouge">chr_sequence</code> value in
turn and <code class="language-plaintext highlighter-rouge">print()</code> prints it to the console.</p>

<blockquote>
  <h4 id="quick-exercise">Quick exercise</h4>

  <p>Can you modify the above loop so that it works through both the
<code class="language-plaintext highlighter-rouge">num_sequence</code> and <code class="language-plaintext highlighter-rouge">chr_sequence</code> in the same loop? (HINT: how might
you combine/concatenate the two sequences?)</p>
</blockquote>

<p>Another way to make a for loop is work through a vector by its indices,
that is, instead of pulling out each item directly and storing it in
<code class="language-plaintext highlighter-rouge">i</code>, we can use <code class="language-plaintext highlighter-rouge">i</code> as an <em>index counter</em> and then call items based on
their index: <code class="language-plaintext highlighter-rouge">chr_sequence[i]</code>. Here’s an example.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## for loop by indices</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">chr_sequence</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">print</span><span class="p">(</span><span class="n">chr_sequence</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] "a"
[1] "b"
[1] "c"
[1] "d"
[1] "e"
[1] "f"
[1] "g"
[1] "h"
[1] "i"
[1] "j"
</code></pre></div></div>

<p>To understand what’s happening, let’s break the code into pieces to make
it clearer.</p>

<p>Inside the <code class="language-plaintext highlighter-rouge">for()</code> parentheses, we have <code class="language-plaintext highlighter-rouge">i in 1:length(chr_sequence)</code>.
We know what <code class="language-plaintext highlighter-rouge">i in</code> means since it’s like what we’ve seen before. What’s
<code class="language-plaintext highlighter-rouge">1:length(chr_sequence)</code>? First, it looks like the colon construction
we’ve seen before, <code class="language-plaintext highlighter-rouge">&lt;start&gt;:&lt;end&gt;</code>, which means give the full sequence
of values from <code class="language-plaintext highlighter-rouge">&lt;start&gt;</code> through <code class="language-plaintext highlighter-rouge">&lt;end&gt;</code>.</p>

<p>Since we made it above, we know that there are ten letters in
<code class="language-plaintext highlighter-rouge">chr_sequence</code>. We could just use <code class="language-plaintext highlighter-rouge">1:10</code>. However, this violates our
<strong>no magic numbers</strong> rule (what happens if we want to add or subtract
letters from the list later?).</p>

<p>We can get around this issue by using the base-R function, <code class="language-plaintext highlighter-rouge">length()</code>,
which will return the number of items in a one-dimensional object. Since
we know that <code class="language-plaintext highlighter-rouge">length(chr_sequence)</code> is equal to <code class="language-plaintext highlighter-rouge">10</code>, that means that
<code class="language-plaintext highlighter-rouge">1:length(chr_sequence)</code> is the same thing as saying <code class="language-plaintext highlighter-rouge">1:10</code>. It’s just
another more flexible way to get the end number of our sequence. We can
show this by just printing <code class="language-plaintext highlighter-rouge">i</code> again.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## for loop by indices (just show indices)</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">chr_sequence</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] 1
[1] 2
[1] 3
[1] 4
[1] 5
[1] 6
[1] 7
[1] 8
[1] 9
[1] 10
</code></pre></div></div>

<p>Back to the original function, we see that inside the braces (<code class="language-plaintext highlighter-rouge">{}</code>), we
have <code class="language-plaintext highlighter-rouge">print(chr_sequence[i])</code>. From earlier lessons, we know that
brackets (<code class="language-plaintext highlighter-rouge">[]</code>) are way of pulling out specific values from a vector.
We’ve only used numbers before, but we can also use variables that
represent numbers. Here’s a non-looped test:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## confirm that we can use variables as indices</span><span class="w">
</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w">                     </span><span class="c1"># set i == 1</span><span class="w">
</span><span class="n">chr_sequence</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w">      
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] "a"
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">2</span><span class="w">                     </span><span class="c1"># now set i == 2</span><span class="w">
</span><span class="n">chr_sequence</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w">            </span><span class="c1"># notice that code is exactly the same here</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] "b"
</code></pre></div></div>

<p>We know that <code class="language-plaintext highlighter-rouge">i</code> is going to take on values 1 through 10 in the loop,
which means the <code class="language-plaintext highlighter-rouge">print()</code> function will get <code class="language-plaintext highlighter-rouge">chr_sequence[1]</code>,
<code class="language-plaintext highlighter-rouge">chr_sequence[2]</code>, and so on. Because of the brackets, these will turn
into…<code class="language-plaintext highlighter-rouge">a</code>, <code class="language-plaintext highlighter-rouge">b</code>, and so on. We should get the same thing as before! Let’s
put all the pieces together and run again:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## for loop by indices (once again)</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">chr_sequence</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">print</span><span class="p">(</span><span class="n">chr_sequence</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] "a"
[1] "b"
[1] "c"
[1] "d"
[1] "e"
[1] "f"
[1] "g"
[1] "h"
[1] "i"
[1] "j"
</code></pre></div></div>

<p>Success!</p>

<p>Whether you decide to loop using actual values from the sequence or
indices will usually depend on the code you want to run in the loop.
Sometimes one way works better and other times the other. Just do
whatever works best for you at that time.</p>

<blockquote>
  <h4 id="quick-exercise-1">Quick exercise</h4>

  <p>Add another print statement to the last loop that shows the value of
<code class="language-plaintext highlighter-rouge">i</code> with each loop.</p>
</blockquote>

<h2 id="while">while</h2>

<p>The <code class="language-plaintext highlighter-rouge">while()</code> function is similar to <code class="language-plaintext highlighter-rouge">for()</code> except that it doesn’t have
a predetermined stopping point. As long the expression inside the
parentheses is <code class="language-plaintext highlighter-rouge">TRUE</code>, the loop will keep going. Only when it becomes
<code class="language-plaintext highlighter-rouge">FALSE</code> will it stop.</p>

<p>One way to use a <code class="language-plaintext highlighter-rouge">while()</code> loop is to set up a counter. When the counter
reaches some value, the expression inside the <code class="language-plaintext highlighter-rouge">while()</code> parentheses is
no longer true and the loop stops.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## set up a counter</span><span class="w">
</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="c1">## with each loop, add one to i</span><span class="w">
</span><span class="k">while</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">11</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w">
    </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] 1
[1] 2
[1] 3
[1] 4
[1] 5
[1] 6
[1] 7
[1] 8
[1] 9
[1] 10
</code></pre></div></div>

<p>Using a <code class="language-plaintext highlighter-rouge">while()</code> loop with a counter is often the same as using a
<code class="language-plaintext highlighter-rouge">for()</code> loop with a sequence. If that’s the case, it’s probably better
just to use a <code class="language-plaintext highlighter-rouge">for()</code> loop.</p>

<p><code class="language-plaintext highlighter-rouge">while()</code> loops are most useful when it’s not clear from the start when
the loop should stop. Imagine you have an algorithm that should only
stop when a certain number is reached. If the time it takes to reach the
number changes depending on the input, then a <code class="language-plaintext highlighter-rouge">for()</code> loop probably
won’t work, but a <code class="language-plaintext highlighter-rouge">while()</code> loop will.</p>

<p>You have to careful, however, with <code class="language-plaintext highlighter-rouge">while()</code> loops. If you forget to
increment the counter (like I did the first time I set up this example),
the loop won’t ever stop because <code class="language-plaintext highlighter-rouge">i</code> will never get larger and will
always be less than 11! If your <code class="language-plaintext highlighter-rouge">while()</code> loop will only stop when a
certain condition is met, it’s still a good idea to build in a
pre-specified number of trials. If your loop has tried <em>X</em> times to meet
the condition and still hasn’t done so, it should stop with an error or
return what it has so far (depending on your needs).</p>

<p>You have been warned!</p>

<h2 id="if">if</h2>

<p>We’ve already used a version of if, <code class="language-plaintext highlighter-rouge">ifelse()</code>, quite a bit. We can use
<strong>if</strong> statements in our script to decide whether a section of code
should be run or skipped. We can also use <code class="language-plaintext highlighter-rouge">if()</code> inside a <code class="language-plaintext highlighter-rouge">for()</code> loop
to set a condition that changes behavior on some iterations of the loop.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## only print if number is not 5</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">num_sequence</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="m">5</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] 1
[1] 2
[1] 3
[1] 4
[1] 6
[1] 7
[1] 8
[1] 9
[1] 10
</code></pre></div></div>

<p>Notice how <code class="language-plaintext highlighter-rouge">5</code> wasn’t printed to the console. It worked!</p>

<blockquote>
  <h4 id="quick-exercise-2">Quick exercise</h4>

  <p>Change the condition to print only numbers below 3 and above 7.</p>
</blockquote>

<p>We can add one or more <code class="language-plaintext highlighter-rouge">else if() / else()</code> partners to <code class="language-plaintext highlighter-rouge">if()</code> if we
need, for example, option <strong>B</strong> to happen if option <strong>A</strong> does not.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## if/else loop</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">num_sequence</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="m">5</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w">
    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">print</span><span class="p">(</span><span class="s1">'three'</span><span class="p">)</span><span class="w">
    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">print</span><span class="p">(</span><span class="s1">'five'</span><span class="p">)</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] 1
[1] 2
[1] "three"
[1] 4
[1] "five"
[1] 6
[1] 7
[1] 8
[1] 9
[1] 10
</code></pre></div></div>

<p>As with {dplyr} verbs, the small number of control functions (and there
are some others) can be combined in an infinite number of ways to help
you control how your script is read. If you find, however, that your
script keeps getting more complex, with multiple nested loops and
<code class="language-plaintext highlighter-rouge">ifelse()</code> exceptions, it might be time to either rethink your approach
or to write your own functions that can handle expectations in a clearer
way.</p>

<h1 id="part-2-writing-functions">Part 2: Writing functions</h1>

<p>You can write your own functions in R and should! They don’t need to be
complex. In fact, they tend to be best when kept simple. Mostly, you
want a function to do one thing really well.</p>

<p>To make a function, you use the <code class="language-plaintext highlighter-rouge">function()</code> function. Put the code that
you want your function to run in the braces <code class="language-plaintext highlighter-rouge">{}</code>. Any arguments that you
want your function to take should be in the parentheses <code class="language-plaintext highlighter-rouge">()</code> right after
the word <code class="language-plaintext highlighter-rouge">function</code>. The name of your function is the name of the object
you assign it to.</p>

<p>Let’s make one. The function below, <code class="language-plaintext highlighter-rouge">say_hi()</code>, doesn’t take any
arguments and prints a simple string when called. After you’ve built it,
call your function using its name, not forgetting to include the
parentheses.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## function to say hi!</span><span class="w">
</span><span class="n">say_hi</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">print</span><span class="p">(</span><span class="s2">"Hi!"</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c1">## call it</span><span class="w">
</span><span class="n">say_hi</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] "Hi!"
</code></pre></div></div>

<p>Let’s make another one with an argument so that it’s more flexible.
Let’s have our function take a name and print it. We’ll use the base-R
function, <code class="language-plaintext highlighter-rouge">paste0()</code>, to combine all the string parts into one string.
<code class="language-plaintext highlighter-rouge">paste0()</code> is like <code class="language-plaintext highlighter-rouge">paste()</code>, but it assumes we don’t want any space
between the pieces. That works for us here because we’ll add our spaces
manually.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## function to say hi!</span><span class="w">
</span><span class="n">say_hi</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="c1">## combine (notice we add space after comma)</span><span class="w">
    </span><span class="n">out_string</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="s2">"Hi, "</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s2">"!"</span><span class="p">)</span><span class="w">
    </span><span class="c1">## print output string</span><span class="w">
    </span><span class="n">print</span><span class="p">(</span><span class="n">out_string</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c1">## call it</span><span class="w">
</span><span class="n">say_hi</span><span class="p">(</span><span class="s2">"Leo"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] "Hi, Leo!"
</code></pre></div></div>

<p>This time, we want it to print out a sequence of numbers, but we want to
be able to change the number each time we call it.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## new function to print sequence of numbers</span><span class="w">
</span><span class="n">print_nums</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">num_vector</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="c1">## this code looks familiar...</span><span class="w">
    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">num_vector</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c1">## try it out!</span><span class="w">
</span><span class="n">print_nums</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">10</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] 1
[1] 2
[1] 3
[1] 4
[1] 5
[1] 6
[1] 7
[1] 8
[1] 9
[1] 10
</code></pre></div></div>

<p>Notice how the variable <code class="language-plaintext highlighter-rouge">num_vector</code> is repeated in both the main
function argument and inside the <code class="language-plaintext highlighter-rouge">for</code> parentheses. The <code class="language-plaintext highlighter-rouge">for()</code> function
sees <code class="language-plaintext highlighter-rouge">num_vector</code> and looks for it in the main function. It finds it
because the <code class="language-plaintext highlighter-rouge">num_vector</code> you give the main function, <code class="language-plaintext highlighter-rouge">print_nums()</code>, is
passed through to the code inside. Now <code class="language-plaintext highlighter-rouge">for()</code> can see it and use it!
Let’s try a few more inputs:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## v1</span><span class="w">
</span><span class="n">print_nums</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] 1
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## v2</span><span class="w">
</span><span class="n">print_nums</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] 1
[1] 2
[1] 3
[1] 4
[1] 5
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## v3</span><span class="w">
</span><span class="n">print_nums</span><span class="p">(</span><span class="n">seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] 1
[1] 3
[1] 5
[1] 7
[1] 9
[1] 11
[1] 13
[1] 15
[1] 17
[1] 19
</code></pre></div></div>

<blockquote>
  <h4 id="quick-exercise-3">Quick exercise</h4>

  <p>What happens if you forget to put an argument in your new function?
How do you think you might set a default argument for <code class="language-plaintext highlighter-rouge">num_vector</code>?
Could you set it equal to something?</p>
</blockquote>

<p>One last thing to keep in mind about functions is that they follow Vegas
rules: <em>what happens inside the function, stays inside the function</em>. A
more technical way of stating this is that the function has its own
<a href="https://en.wikipedia.org/wiki/Scope_\(computer_science\)"><strong>scope</strong></a>
and objects created / processes run within that scope stay within that
scope. That’s why even though we created an object called <code class="language-plaintext highlighter-rouge">out_string</code>
in our <code class="language-plaintext highlighter-rouge">say_hi()</code> function, we can’t call it directly from the console.
It only exists while the function is running and goes away once the
function completes.</p>

<p>Even if we repeat an object name that exists in our <strong>global</strong> (working)
environment inside our function, the value we give it inside the
function will override the global value within the function. But once
the function is finished, the global value will again take precedence.
Don’t worry to much about scoping (<a href="https://bookdown.org/rdpeng/rprogdatascience/scoping-rules-of-r.html">here’s more information if you are
interested</a>),
but just be aware that it’s generally good practice that if you want an
object for use inside your function, you should either create it there
or make it an argument.</p>

<h1 id="part-3-practical-examples">Part 3: Practical examples</h1>

<h2 id="example-1-missing-data">Example 1: missing data</h2>

<p>Now that we’ve seen some control flow and programming methods, let’s
move to a more realistic use case. In this first example, we’ll make a
function that fills in missing values, a common task we’ve had. First,
we’ll generate some fake data with missing values.</p>

<p>Note that since we’re using R’s <code class="language-plaintext highlighter-rouge">sample()</code> function, your data will look
a little different from mine due to randomness in the sample, but
everything will work the same.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## create a data frame with around 10% missing values (-97,-98,-99) in</span><span class="w">
</span><span class="c1">## three columns</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tibble</span><span class="p">(</span><span class="s2">"id"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">100</span><span class="p">,</span><span class="w">
             </span><span class="s2">"age"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sample</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">seq</span><span class="p">(</span><span class="m">11</span><span class="p">,</span><span class="m">20</span><span class="p">,</span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="m">-97</span><span class="p">),</span><span class="w">
                            </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="p">,</span><span class="w">
                            </span><span class="n">replace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w">
                            </span><span class="n">prob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="m">.09</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">),</span><span class="w"> </span><span class="m">.1</span><span class="p">)),</span><span class="w">
             </span><span class="s2">"sibage"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sample</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">seq</span><span class="p">(</span><span class="m">5</span><span class="p">,</span><span class="m">12</span><span class="p">,</span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="m">-98</span><span class="p">),</span><span class="w">
                               </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="p">,</span><span class="w">
                               </span><span class="n">replace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w">
                               </span><span class="n">prob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="m">.115</span><span class="p">,</span><span class="w"> </span><span class="m">8</span><span class="p">),</span><span class="w"> </span><span class="m">.08</span><span class="p">)),</span><span class="w">
             </span><span class="s2">"parage"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sample</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">seq</span><span class="p">(</span><span class="m">45</span><span class="p">,</span><span class="m">55</span><span class="p">,</span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-98</span><span class="p">,</span><span class="m">-99</span><span class="p">)),</span><span class="w">
                               </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="p">,</span><span class="w">
                               </span><span class="n">replace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w">
                               </span><span class="n">prob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="m">.085</span><span class="p">,</span><span class="w"> </span><span class="m">11</span><span class="p">),</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">.12</span><span class="p">,</span><span class="w"> </span><span class="m">.12</span><span class="p">)))</span><span class="w">
             </span><span class="p">)</span><span class="w"> 
</span><span class="c1">## show</span><span class="w">
</span><span class="n">df</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># A tibble: 100 x 4
      id   age sibage parage
   &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
 1     1   -97      9     46
 2     2    12     10     52
 3     3    18      7     49
 4     4    12     12     49
 5     5    16     12     54
 6     6    13      9     47
 7     7    13      6     45
 8     8   -97     11     48
 9     9    19      7     54
10    10    20      5     54
# … with 90 more rows
</code></pre></div></div>

<p>We could fix these manually like we have been in past lessons and
assignments, but it would be nice have a shorthand function. The
function needs to flexible though, because the missing data values are
coded differently in each column.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## function to fix missing values</span><span class="w">
</span><span class="n">fix_missing</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">miss_val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="c1">## use ifelse(&lt; test &gt;, &lt; do this if TRUE &gt;, &lt; do that if FALSE &gt;)</span><span class="w">
    </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">miss_val</span><span class="p">,</span><span class="w">        </span><span class="c1"># is x == any value in miss_val?</span><span class="w">
                </span><span class="kc">NA</span><span class="p">,</span><span class="w">                     </span><span class="c1"># TRUE: replace with NA</span><span class="w">
                </span><span class="n">x</span><span class="p">)</span><span class="w">                      </span><span class="c1"># FALSE: return original value as is</span><span class="w">
    </span><span class="c1">## return corrected x</span><span class="w">
    </span><span class="nf">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Our <code class="language-plaintext highlighter-rouge">fix_missing()</code> function should meet our needs. It takes the same
<code class="language-plaintext highlighter-rouge">ifelse()</code> function we’ve used before, but instead of using the name of
the object (like <code class="language-plaintext highlighter-rouge">df</code>), uses an argument name <code class="language-plaintext highlighter-rouge">x</code> that we can set each
time. It does the same for <code class="language-plaintext highlighter-rouge">miss_val</code>. Instead of choosing a hard-coded
value (a <a href="https://en.wikipedia.org/wiki/Magic_number_\(programming\)">magic
number</a>), we
can change it each time we call the function. Let’s try it out.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## check</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">count</span><span class="p">(</span><span class="n">age</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># A tibble: 11 x 2
     age     n
   &lt;dbl&gt; &lt;int&gt;
 1   -97    15
 2    11     7
 3    12     7
 4    13    16
 5    14     9
 6    15     7
 7    16     5
 8    17     9
 9    18    12
10    19     8
11    20     5
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## missing values in age are coded as -97</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">mutate</span><span class="p">(</span><span class="n">age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fix_missing</span><span class="p">(</span><span class="n">age</span><span class="p">,</span><span class="w"> </span><span class="m">-97</span><span class="p">))</span><span class="w">

</span><span class="c1">## recheck</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">count</span><span class="p">(</span><span class="n">age</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># A tibble: 11 x 2
     age     n
   &lt;dbl&gt; &lt;int&gt;
 1    11     7
 2    12     7
 3    13    16
 4    14     9
 5    15     7
 6    16     5
 7    17     9
 8    18    12
 9    19     8
10    20     5
11    NA    15
</code></pre></div></div>

<p>It worked! All the values that were -97 before, are now in the <code class="language-plaintext highlighter-rouge">NA</code>
table column. Importantly, none of the other values changed.</p>

<blockquote>
  <h4 id="quick-exercise-4">Quick exercise</h4>

  <p>Correct the missing values in the other columns using our new
function. <strong>NOTE</strong> that <code class="language-plaintext highlighter-rouge">parage</code> has missing values of <code class="language-plaintext highlighter-rouge">-98</code> and
<code class="language-plaintext highlighter-rouge">-99</code>.</p>
</blockquote>

<h2 id="example-2-batch-read-files">Example 2: batch read files</h2>

<h3 id="download-all-files">Download all files</h3>

<p>In our lesson on appending, joining, and merging, we read in a few
administrative test score files. In that lesson, we read in each file
individually and then appended them.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## read in all Bend Gate test score files</span><span class="w">
</span><span class="n">df_1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="n">file.path</span><span class="p">(</span><span class="n">bys_dir</span><span class="p">,</span><span class="w"> </span><span class="s2">"bend_gate_1980.csv"</span><span class="p">))</span><span class="w">
</span><span class="n">df_2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="n">file.path</span><span class="p">(</span><span class="n">bys_dir</span><span class="p">,</span><span class="w"> </span><span class="s2">"bend_gate_1981.csv"</span><span class="p">))</span><span class="w">
</span><span class="n">df_3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="n">file.path</span><span class="p">(</span><span class="n">bys_dir</span><span class="p">,</span><span class="w"> </span><span class="s2">"bend_gate_1982.csv"</span><span class="p">))</span><span class="w">
</span><span class="n">df_4</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="n">file.path</span><span class="p">(</span><span class="n">bys_dir</span><span class="p">,</span><span class="w"> </span><span class="s2">"bend_gate_1983.csv"</span><span class="p">))</span><span class="w">
</span><span class="n">df_5</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="n">file.path</span><span class="p">(</span><span class="n">bys_dir</span><span class="p">,</span><span class="w"> </span><span class="s2">"bend_gate_1984.csv"</span><span class="p">))</span><span class="w">
</span><span class="n">df_6</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="n">file.path</span><span class="p">(</span><span class="n">bys_dir</span><span class="p">,</span><span class="w"> </span><span class="s2">"bend_gate_1985.csv"</span><span class="p">))</span><span class="w">

</span><span class="c1">## append</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">bind_rows</span><span class="p">(</span><span class="n">df_1</span><span class="p">,</span><span class="w"> </span><span class="n">df_2</span><span class="p">,</span><span class="w"> </span><span class="n">df_3</span><span class="p">,</span><span class="w"> </span><span class="n">df_4</span><span class="p">,</span><span class="w"> </span><span class="n">df_5</span><span class="p">,</span><span class="w"> </span><span class="n">df_6</span><span class="p">)</span><span class="w">

</span><span class="c1">## show</span><span class="w">
</span><span class="n">df</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># A tibble: 6 x 5
  school     year  math  read science
  &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
1 Bend Gate  1980   515   281     808
2 Bend Gate  1981   503   312     814
3 Bend Gate  1982   514   316     816
4 Bend Gate  1983   491   276     793
5 Bend Gate  1984   502   310     788
6 Bend Gate  1985   488   280     789
</code></pre></div></div>

<p>That was fine then, but when you see that much repeated code, you should
immediately consider using a more functional programming approach. What
if we wanted to read in all the files for the other schools as well?
That would be a total of 24 very similar lines of code — ripe for
introducing bugs.</p>

<p>Let’s combine a number of the skills we’ve learned to this point —
functions, regular expressions, and pipes — to read and bind all the
test score files in a more functional (and less buggy) manner.</p>

<p>First, we’ll store the names of the files in an object using
<code class="language-plaintext highlighter-rouge">list.files()</code>. We’ve used the <code class="language-plaintext highlighter-rouge">list.files()</code> function a few times in
class when checking that we were in the correct working directory. In
those situations, we’ve just printed the output to the console. But as
with all things R, we can save that output in an object instead and put
it to good use.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## get names (with full path) of all school test score files</span><span class="w">
</span><span class="n">files</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">list.files</span><span class="p">(</span><span class="n">bys_dir</span><span class="p">,</span><span class="w"> </span><span class="n">full.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">

</span><span class="c1">## show</span><span class="w">
</span><span class="n">files</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> [1] "../data/sch_test/by_school/bend_gate_1980.csv"   
 [2] "../data/sch_test/by_school/bend_gate_1981.csv"   
 [3] "../data/sch_test/by_school/bend_gate_1982.csv"   
 [4] "../data/sch_test/by_school/bend_gate_1983.csv"   
 [5] "../data/sch_test/by_school/bend_gate_1984.csv"   
 [6] "../data/sch_test/by_school/bend_gate_1985.csv"   
 [7] "../data/sch_test/by_school/east_heights_1980.csv"
 [8] "../data/sch_test/by_school/east_heights_1981.csv"
 [9] "../data/sch_test/by_school/east_heights_1982.csv"
[10] "../data/sch_test/by_school/east_heights_1983.csv"
[11] "../data/sch_test/by_school/east_heights_1984.csv"
[12] "../data/sch_test/by_school/east_heights_1985.csv"
[13] "../data/sch_test/by_school/niagara_1980.csv"     
[14] "../data/sch_test/by_school/niagara_1981.csv"     
[15] "../data/sch_test/by_school/niagara_1982.csv"     
[16] "../data/sch_test/by_school/niagara_1983.csv"     
[17] "../data/sch_test/by_school/niagara_1984.csv"     
[18] "../data/sch_test/by_school/niagara_1985.csv"     
[19] "../data/sch_test/by_school/spottsville_1980.csv" 
[20] "../data/sch_test/by_school/spottsville_1981.csv" 
[21] "../data/sch_test/by_school/spottsville_1982.csv" 
[22] "../data/sch_test/by_school/spottsville_1983.csv" 
[23] "../data/sch_test/by_school/spottsville_1984.csv" 
[24] "../data/sch_test/by_school/spottsville_1985.csv" 
</code></pre></div></div>

<blockquote>
  <h4 id="quick-exercise-5">Quick exercise</h4>

  <p>Rerun <code class="language-plaintext highlighter-rouge">list.files()</code> again, but set the <code class="language-plaintext highlighter-rouge">full.names</code> argument to the
default value of <code class="language-plaintext highlighter-rouge">FALSE</code>. What does the output look like? Why is this
a problem? (Once finished, be sure to set <code class="language-plaintext highlighter-rouge">full.names = TRUE</code> again
and rerun.)</p>
</blockquote>

<p>Now that we have an object, we can read in the files using a loop. We’ll
need something to store them in along the way. We’ll use a blank list.
We’ve not used lists before, but think of them as special vectors, which
we have used.</p>

<p>Once we have a list, we’ll read in each file, but instead of storing it
in an object like <code class="language-plaintext highlighter-rouge">df</code>, we’ll put it in the list.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## init list</span><span class="w">
</span><span class="n">df_list</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">()</span><span class="w">

</span><span class="c1">## use loop to read in files</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">files</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="c1">## read in file (f) and store in list (note double brackets for list)</span><span class="w">
    </span><span class="n">df_list</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">    
</span><span class="p">}</span><span class="w">

</span><span class="c1">## show first 3 items</span><span class="w">
</span><span class="n">df_list</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[[1]]
# A tibble: 1 x 5
  school     year  math  read science
  &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
1 Bend Gate  1980   515   281     808

[[2]]
# A tibble: 1 x 5
  school     year  math  read science
  &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
1 Bend Gate  1981   503   312     814

[[3]]
# A tibble: 1 x 5
  school     year  math  read science
  &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
1 Bend Gate  1982   514   316     816
</code></pre></div></div>

<p>Now that the items are in a list, we can again use <code class="language-plaintext highlighter-rouge">bind_rows()</code>, which,
in addition to individual objects, can take a single list of objects.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## bind our list to single data frame</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df_list</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">bind_rows</span><span class="p">()</span><span class="w">

</span><span class="c1">## show</span><span class="w">
</span><span class="n">df</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># A tibble: 24 x 5
   school        year  math  read science
   &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
 1 Bend Gate     1980   515   281     808
 2 Bend Gate     1981   503   312     814
 3 Bend Gate     1982   514   316     816
 4 Bend Gate     1983   491   276     793
 5 Bend Gate     1984   502   310     788
 6 Bend Gate     1985   488   280     789
 7 East Heights  1980   501   318     782
 8 East Heights  1981   487   323     813
 9 East Heights  1982   496   294     818
10 East Heights  1983   497   306     795
# … with 14 more rows
</code></pre></div></div>

<p>Aside from being more aesthetically pleasing, this code is better
because it:</p>

<ul>
  <li>doesn’t rely on repeated lines of code with small changes</li>
  <li>is flexible</li>
</ul>

<p>Imagine you receive three more years of data for each school: 1986,
1987, 1988. As long as the files are in the same format, all you need to
do is put the same directory as the other files and rerun your code. It
will add them to the <code class="language-plaintext highlighter-rouge">files</code> vector and your loop will run just as
before.</p>

<h3 id="read-in-only-some-files">Read in only some files</h3>

<p>What if we only want files for Spottsville? Overall, the code is exactly
the same except that we want our list to only contain the
<code class="language-plaintext highlighter-rouge">spottsville_*.csv</code> files. How can we do that? With regular
expressions!</p>

<p>Notice that the second argument in <code class="language-plaintext highlighter-rouge">list.files()</code> is <code class="language-plaintext highlighter-rouge">pattern</code> with a
default value of <code class="language-plaintext highlighter-rouge">NULL</code>. This means it doesn’t do any filtering if we
leave it out. But if we want to filter which files are stored in
<code class="language-plaintext highlighter-rouge">files</code>, we should use it.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## filter files to be read in using pattern</span><span class="w">
</span><span class="n">files_sp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">list.files</span><span class="p">(</span><span class="n">bys_dir</span><span class="p">,</span><span class="w"> </span><span class="n">pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"spottsville"</span><span class="p">,</span><span class="w"> </span><span class="n">full.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">

</span><span class="c1">## check</span><span class="w">
</span><span class="n">files_sp</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] "../data/sch_test/by_school/spottsville_1980.csv"
[2] "../data/sch_test/by_school/spottsville_1981.csv"
[3] "../data/sch_test/by_school/spottsville_1982.csv"
[4] "../data/sch_test/by_school/spottsville_1983.csv"
[5] "../data/sch_test/by_school/spottsville_1984.csv"
[6] "../data/sch_test/by_school/spottsville_1985.csv"
</code></pre></div></div>

<p>Luckily, our regular expression pattern can simply be <code class="language-plaintext highlighter-rouge">"spottsville"</code>.
Were our files less consistently named, we might have had trouble (name
those files well!).</p>

<p>The rest of the code should be as it was before (with the small addition
of <code class="language-plaintext highlighter-rouge">_sp</code> in various names to keep distinct from our first attempt).</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## init list</span><span class="w">
</span><span class="n">df_sp_list</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">()</span><span class="w">

</span><span class="c1">## use loop to read in files</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">files_sp</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="c1">## read in file (f) and store in list</span><span class="w">
    </span><span class="n">df_sp_list</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="n">files_sp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w">    
</span><span class="p">}</span><span class="w">

</span><span class="c1">## bind our list to single data frame</span><span class="w">
</span><span class="n">df_sp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">df_sp_list</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">bind_rows</span><span class="p">()</span><span class="w">

</span><span class="c1">## show</span><span class="w">
</span><span class="n">df_sp</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># A tibble: 6 x 5
  school       year  math  read science
  &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
1 Spottsville  1980   498   288     813
2 Spottsville  1981   494   270     765
3 Spottsville  1982   507   289     801
4 Spottsville  1983   515   288     775
5 Spottsville  1984   475   289     779
6 Spottsville  1985   515   285     784
</code></pre></div></div>

<h3 id="use-purrrmap">Use <code class="language-plaintext highlighter-rouge">purrr::map()</code></h3>

<p>Finally, let’s look at the fully {tidyverse} way of solving this
problem. We’ll use the {purrr} library, which is loaded when we load
{tidyverse}, and approaches functional programming more like other
languages. Specifically, we’ll use <code class="language-plaintext highlighter-rouge">map()</code>. <a href="https://purrr.tidyverse.org/reference/index.html">According the reference
site</a>:</p>

<blockquote>
  <p>The <code class="language-plaintext highlighter-rouge">map(.x, .f)</code> functions transforms each element of the vector <code class="language-plaintext highlighter-rouge">.x</code>
with the function <code class="language-plaintext highlighter-rouge">.f</code>, returning a vector defined by the suffix
(<code class="language-plaintext highlighter-rouge">_lgl</code>,<code class="language-plaintext highlighter-rouge">_chr()</code> etc).</p>
</blockquote>

<p>Okay…</p>

<p>Restated, <code class="language-plaintext highlighter-rouge">map()</code> works this way: for each item in an object (<code class="language-plaintext highlighter-rouge">.x</code>), do
something (<code class="language-plaintext highlighter-rouge">.f</code>) — the <em>something</em> being a function. From our file
reading loops above, we already have our object and our main thing we
want to do (function):</p>

<ul>
  <li><strong>object</strong> := file list (<code class="language-plaintext highlighter-rouge">files</code>)</li>
  <li><strong>function</strong> := <code class="language-plaintext highlighter-rouge">read_csv()</code></li>
</ul>

<p>What’s nice about {purrr} functions is that they work directly with
other {tidyverse} functions via pipes, <code class="language-plaintext highlighter-rouge">%&gt;%</code>. This bit of code
reproduces what the first loop did to read in and bind all files:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## use purrr::map() to read in all files; then pipe into bind rows</span><span class="w">
</span><span class="n">df</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">map</span><span class="p">(</span><span class="n">files</span><span class="p">,</span><span class="w">
          </span><span class="o">~</span><span class="w"> </span><span class="n">read_csv</span><span class="p">(</span><span class="n">.x</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
    </span><span class="n">bind_rows</span><span class="p">()</span><span class="w">

</span><span class="c1">## show</span><span class="w">
</span><span class="n">df</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># A tibble: 24 x 5
   school        year  math  read science
   &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
 1 Bend Gate     1980   515   281     808
 2 Bend Gate     1981   503   312     814
 3 Bend Gate     1982   514   316     816
 4 Bend Gate     1983   491   276     793
 5 Bend Gate     1984   502   310     788
 6 Bend Gate     1985   488   280     789
 7 East Heights  1980   501   318     782
 8 East Heights  1981   487   323     813
 9 East Heights  1982   496   294     818
10 East Heights  1983   497   306     795
# … with 14 more rows
</code></pre></div></div>

<p>What’s happening here? One at a time;</p>

<ol>
  <li>every item in <code class="language-plaintext highlighter-rouge">files</code> becomes <code class="language-plaintext highlighter-rouge">.x</code></li>
  <li><code class="language-plaintext highlighter-rouge">read_csv(.x)</code> is run (in <code class="language-plaintext highlighter-rouge">map()</code>, the tilde, <code class="language-plaintext highlighter-rouge">~</code>, tells R that a
function is coming next). Since the items in <code class="language-plaintext highlighter-rouge">files</code> are paths,
<code class="language-plaintext highlighter-rouge">read_csv()</code> works as it always does.</li>
</ol>

<p>The output of <code class="language-plaintext highlighter-rouge">map()</code> is a list. Before, we had to initialize a blank
list, <code class="language-plaintext highlighter-rouge">df_list()</code>. But this time we can just use a <code class="language-plaintext highlighter-rouge">%&gt;%</code> to send the
output of <code class="language-plaintext highlighter-rouge">map()</code> (a list), to <code class="language-plaintext highlighter-rouge">bind_rows()</code> and assign the <strong>final</strong>
result to <code class="language-plaintext highlighter-rouge">df</code>: our full data frame!</p>

<p>This code is much more compact than our loops above. That said, it also
is more abstract (read: less clear). In certain situations, using
<code class="language-plaintext highlighter-rouge">map()</code> in place of a <code class="language-plaintext highlighter-rouge">for()</code> loop may be faster. But in general, you
are just fine using loops. That said, functional programming via the
{purrr} suite of functions can be very powerful and may be worth
learning more about.</p>



	<!-- <p> -->
	<!--   Updated:  -->
	<!-- </p> -->
      </section>
      <footer>
        <p>
  Benjamin Skinner</br>  
  Assistant Professor</br>  
  University of Florida</br>
  <a href="https://www.btskinner.io" class="iconlink" alt="Personal website">
    <i class="fas fa-home fa-lg"></i></a> | 
  <a href="https://github.com/btskinner" class="iconlink" alt="Github
								profile">
    <i class="fab fa-github fa-lg"></i></a> |
  <a href="https://twitter.com/btskinner" class="iconlink" alt="Twitter profile">
    <i class="fab fa-twitter fa-lg"></i></a>
</p>
<p>
  <small>
    <a href="https://pages.github.com">GitHub Pages</a> |
    <a href="https://github.com/orderedlist/minimal">Theme</a> |
    <a href="/past/edh7916/2020/spring/releases/">Releases</a>
  </small>
</p>

      </footer>
    </div>

    <!-- load Javascript if page requires it -->
    
    
    

    
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-63981025-1', 'auto');
        ga('send', 'pageview');
    </script>
  
  </body>
</html>
